<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mafia Moderator Pro</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Outfit:wght@300;400;600&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg-dark: #121212;
            --surface: rgba(30, 30, 36, 0.7);
            --surface-hover: rgba(40, 40, 48, 0.9);
            --primary: #e94560;
            --primary-hover: #ff6b6b;
            --accent: #ffd700;
            --text-main: #e0e0e0;
            --text-muted: #a0a0a0;
            --success: #51cf66;
            --border: rgba(255, 255, 255, 0.1);
            --glass: blur(10px);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: var(--bg-dark);
            background-image:
                radial-gradient(circle at 10% 20%, rgba(233, 69, 96, 0.15) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(255, 215, 0, 0.1) 0%, transparent 40%);
            background-attachment: fixed;
            color: var(--text-main);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        h1,
        h2,
        h3 {
            font-family: 'Cinzel', serif;
            letter-spacing: 1px;
        }

        h1 {
            text-align: center;
            margin-bottom: 40px;
            font-size: 3rem;
            background: linear-gradient(45deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 4px 15px rgba(233, 69, 96, 0.3);
            animation: fadeIn 1s ease-out;
        }

        h2 {
            margin-bottom: 20px;
            color: var(--accent);
            border-bottom: 1px solid var(--border);
            padding-bottom: 10px;
            font-size: 1.8rem;
        }

        .section {
            background: var(--surface);
            padding: 30px;
            margin-bottom: 25px;
            border-radius: 16px;
            border: 1px solid var(--border);
            backdrop-filter: var(--glass);
            -webkit-backdrop-filter: var(--glass);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            animation: slideUp 0.5s ease-out;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .section:hover {
            box-shadow: 0 10px 40px 0 rgba(0, 0, 0, 0.5);
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-muted);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        input,
        select {
            width: 100%;
            padding: 12px 15px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-main);
            font-family: 'Outfit', sans-serif;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        select {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23e94560' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 16px;
            cursor: pointer;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: var(--primary);
            background: rgba(0, 0, 0, 0.5);
            box-shadow: 0 0 0 2px rgba(233, 69, 96, 0.2);
        }

        /* Fix for native dropdown options on Windows to match theme */
        select option {
            background-color: #1e1e24;
            /* Hardcoded dark color often works better than var in quirks input */
            color: var(--text-main);
            padding: 10px;
        }

        button {
            padding: 12px 24px;
            background: linear-gradient(135deg, var(--primary) 0%, #c0394d 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-family: 'Outfit', sans-serif;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            margin-right: 10px;
            margin-bottom: 10px;
            box-shadow: 0 4px 15px rgba(233, 69, 96, 0.4);
        }

        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(233, 69, 96, 0.6);
            filter: brightness(1.1);
        }

        button:active {
            transform: translateY(-1px);
        }

        button.secondary {
            background: linear-gradient(135deg, #444 0%, #2a2a2a 100%);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        button.secondary:hover {
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
        }

        button.danger {
            background: linear-gradient(135deg, #8a2a2a 0%, #5a1a1a 100%);
            box-shadow: 0 4px 15px rgba(138, 42, 42, 0.4);
            border: 1px solid rgba(255, 99, 71, 0.3);
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 15px;
            border-radius: 12px;
            overflow: hidden;
            background: rgba(0, 0, 0, 0.2);
        }

        th,
        td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th {
            background: rgba(233, 69, 96, 0.1);
            color: var(--primary);
            font-family: 'Cinzel', serif;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.85rem;
        }

        tr:hover td {
            background: rgba(255, 255, 255, 0.03);
        }

        tr:last-child td {
            border-bottom: none;
        }

        .status-alive {
            color: var(--success);
            font-weight: bold;
            text-shadow: 0 0 10px rgba(81, 207, 102, 0.3);
        }

        .status-dead {
            color: #ff6b6b;
            text-decoration: line-through;
            opacity: 0.7;
        }

        .role-mafia {
            color: #ff4757;
            font-weight: bold;
        }

        .role-doctor {
            color: #2ed573;
            font-weight: bold;
        }

        .role-detective {
            color: #1e90ff;
            font-weight: bold;
        }

        .role-villager {
            color: #eccc68;
        }

        .round-indicator {
            text-align: center;
            font-size: 2rem;
            font-family: 'Cinzel', serif;
            color: var(--accent);
            margin: 30px 0;
            padding: 20px;
            background: linear-gradient(90deg, transparent, rgba(255, 215, 0, 0.1), transparent);
            border-top: 1px solid rgba(255, 215, 0, 0.2);
            border-bottom: 1px solid rgba(255, 215, 0, 0.2);
            animation: pulse 2s infinite;
        }

        .history-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            margin-bottom: 12px;
            border-radius: 8px;
            border-left: 4px solid var(--primary);
            transition: transform 0.2s ease;
        }

        .history-item:hover {
            transform: translateX(5px);
            background: rgba(0, 0, 0, 0.4);
        }

        .history-night {
            border-left-color: #6c5ce7;
        }

        .history-day {
            border-left-color: var(--accent);
        }

        .vote-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            align-items: center;
            background: rgba(255, 255, 255, 0.03);
            padding: 10px;
            border-radius: 8px;
        }

        .vote-row select {
            flex: 1;
            background: transparent;
            border: none;
            border-bottom: 1px solid var(--border);
            border-radius: 0;
        }

        .hidden {
            display: none !important;
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Role Highlighting in Setup */
        .select-mafia {
            border-color: #ff4757 !important;
            box-shadow: 0 0 10px rgba(255, 71, 87, 0.3) !important;
            color: #ff4757 !important;
        }

        .select-doctor {
            border-color: #2ed573 !important;
            box-shadow: 0 0 10px rgba(46, 213, 115, 0.3) !important;
            color: #2ed573 !important;
        }

        .select-detective {
            border-color: #1e90ff !important;
            box-shadow: 0 0 10px rgba(30, 144, 255, 0.3) !important;
            color: #1e90ff !important;
        }

        @keyframes pulse {
            0% {
                text-shadow: 0 0 10px rgba(255, 215, 0, 0.2);
                transform: scale(1);
            }

            50% {
                text-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
                transform: scale(1.05);
            }

            100% {
                text-shadow: 0 0 10px rgba(255, 215, 0, 0.2);
                transform: scale(1);
            }
        }

        @keyframes modalScale {
            from {
                transform: scale(0.9);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: rgba(30, 30, 36, 0.95);
            padding: 30px;
            border-radius: 16px;
            border: 1px solid var(--primary);
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.8);
            animation: modalScale 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .modal-content h3 {
            margin-bottom: 15px;
            color: var(--primary);
        }

        .modal-content p {
            margin-bottom: 25px;
            color: var(--text-main);
        }

        .modal-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .section {
                padding: 20px;
            }

            h1 {
                font-size: 2rem;
            }

            button {
                width: 100%;
                margin-right: 0;
            }

            .vote-row {
                flex-direction: column;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üé≠ Mafia Game Moderator</h1>

        <div id="setupSection" class="section">
            <h2>Game Setup</h2>
            <div class="form-group">
                <label>Number of Players:</label>
                <input type="number" id="numPlayers" min="4" max="50" value="18">
                <button onclick="generatePlayers()">Generate Player List</button>
                <button onclick="loadDefaultPlayers()" class="secondary">Load Default Names</button>
                <button onclick="randomizeRoles()" class="secondary">Randomize Roles</button>
            </div>

            <div id="playerSetup" class="hidden">
                <h3 style="color: #ffd93d; margin-top: 20px;">Player List</h3>
                <div id="playerList"></div>
                <button onclick="addPlayer()">Add Player</button>
                <button onclick="startGame()">Start Game</button>
            </div>
        </div>

        <div id="gameSection" class="hidden">
            <div class="round-indicator">
                <span id="roundDisplay">Night 1</span>
            </div>

            <div class="section">
                <button onclick="nextRound()">Next Round</button>
                <button onclick="showSection('playersTab')" class="secondary">Players</button>
                <button onclick="showSection('nightTab')" class="secondary">Night Actions</button>
                <button onclick="showSection('dayTab')" class="secondary">Day Voting</button>
                <button onclick="showSection('historyTab')" class="secondary">History</button>
                <button onclick="resetGame()" class="danger">Reset Game</button>
            </div>

            <div id="playersTab" class="section">
                <h2>Players</h2>
                <table id="playersTable">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Name</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Death Reason</th>
                            <th>Notes</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="playersTableBody"></tbody>
                </table>
            </div>

            <div id="nightTab" class="section hidden">
                <h2>Night Actions</h2>
                <div class="form-group">
                    <label>Mafia Target:</label>
                    <select id="mafiaTarget"></select>
                </div>
                <div class="form-group">
                    <label>Doctor Save:</label>
                    <select id="doctorSave"></select>
                </div>
                <div class="form-group" id="detectiveSection">
                    <label>Detective Investigation:</label>
                    <select id="detectiveInvestigate"></select>
                </div>

                <button onclick="processNight()">Process Night</button>
            </div>

            <div id="dayTab" class="section hidden">
                <h2>Day Voting</h2>
                <div id="votingArea">
                    <div id="votesList"></div>
                    <button onclick="addVoteForAllPlayers()">Quick Add All Players</button>
                    <button onclick="addVote()" class="secondary">Add Single Vote</button>
                    <button onclick="tallyVotes()">Tally Votes</button>
                </div>
                <div id="voteResults" class="hidden" style="margin-top: 20px;">
                    <h3 style="color: #ffd93d;">Vote Results</h3>
                    <div id="voteTally"></div>
                    <div class="form-group" style="margin-top: 15px;">
                        <label>Eliminate Player:</label>
                        <select id="eliminatedPlayer"></select>
                    </div>
                    <button onclick="processDay()">Confirm Elimination</button>
                </div>
            </div>

            <div id="historyTab" class="section hidden">
                <h2>Game History</h2>
                <div id="historyList"></div>
            </div>
        </div>
    </div>

    <!-- Custom Modal -->
    <div id="confirmModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 id="modalTitle">Confirmation</h3>
            <p id="modalMessage">Are you sure?</p>
            <div class="modal-actions">
                <button id="modalBtnYes">Yes</button>
                <button id="modalBtnNo" class="secondary">No</button>
            </div>
        </div>
    </div>

    <script>
        let gameState = {
            players: [],
            currentRound: 1,
            roundType: 'night',
            history: [],
            votes: []
        };

        const defaultNames = [
            'Harimati', 'Kirtan', 'Krishn', 'Abhi', 'Hitwanshi',
            'Harsh', 'Jaimeen', 'Dhruvil', 'Sumankumar', 'Parth',
            'Kishan', 'Foram', 'Shivam', 'Sumant', 'Navdeep',
            'Yatri', 'Jinali', 'Sunil'
        ];

        function showConfirm(message, title = 'Confirmation') {
            return new Promise((resolve) => {
                const modal = document.getElementById('confirmModal');
                const titleEl = document.getElementById('modalTitle');
                const msgEl = document.getElementById('modalMessage');
                const btnYes = document.getElementById('modalBtnYes');
                const btnNo = document.getElementById('modalBtnNo');

                // Reset state for confirm
                titleEl.textContent = title;
                msgEl.textContent = message;
                btnYes.textContent = 'Yes';
                btnNo.classList.remove('hidden');
                modal.classList.remove('hidden');

                const handleYes = () => {
                    cleanup();
                    resolve(true);
                };

                const handleNo = () => {
                    cleanup();
                    resolve(false);
                };

                const cleanup = () => {
                    btnYes.removeEventListener('click', handleYes);
                    btnNo.removeEventListener('click', handleNo);
                    modal.classList.add('hidden');
                };

                btnYes.addEventListener('click', handleYes);
                btnNo.addEventListener('click', handleNo);
            });
        }

        function showAlert(message, title = 'Alert') {
            return new Promise((resolve) => {
                const modal = document.getElementById('confirmModal');
                const titleEl = document.getElementById('modalTitle');
                const msgEl = document.getElementById('modalMessage');
                const btnYes = document.getElementById('modalBtnYes');
                const btnNo = document.getElementById('modalBtnNo');

                // Custom state for alert
                titleEl.textContent = title;
                msgEl.innerHTML = message.replace(/\n/g, '<br>'); // Support newlines
                btnYes.textContent = 'OK';
                btnNo.classList.add('hidden'); // Hide No button
                modal.classList.remove('hidden');

                const handleOk = () => {
                    cleanup();
                    resolve();
                };

                const cleanup = () => {
                    btnYes.removeEventListener('click', handleOk);
                    modal.classList.add('hidden');
                };

                btnYes.addEventListener('click', handleOk);
            });
        }

        function loadGame() {
            const saved = localStorage.getItem('mafiaGame');
            if (saved) {
                gameState = JSON.parse(saved);
                document.getElementById('setupSection').classList.add('hidden');
                document.getElementById('gameSection').classList.remove('hidden');
                updateGameDisplay();
            }
        }

        function loadDefaultPlayers() {
            const currentNum = parseInt(document.getElementById('numPlayers').value);
            const numToUse = Math.max(currentNum, defaultNames.length);

            document.getElementById('numPlayers').value = numToUse;
            generatePlayers();

            const playerRows = document.querySelectorAll('.player-row');
            playerRows.forEach((row, index) => {
                const nameInput = row.querySelector('.player-name');
                if (nameInput) {
                    if (index < defaultNames.length) {
                        nameInput.value = defaultNames[index];
                    } else {
                        nameInput.value = `Player ${index + 1}`;
                    }
                }
            });
        }

        function saveGame() {
            localStorage.setItem('mafiaGame', JSON.stringify(gameState));
        }

        function generatePlayers() {
            const num = parseInt(document.getElementById('numPlayers').value);
            const list = document.getElementById('playerList');
            list.innerHTML = '';

            for (let i = 1; i <= num; i++) {
                const div = document.createElement('div');
                div.style.display = 'grid';
                div.style.gridTemplateColumns = '50px 1fr 1fr 80px';
                div.style.gap = '10px';
                div.style.marginBottom = '10px';
                div.className = 'player-row';
                div.setAttribute('data-player-num', i);
                div.innerHTML = `
                    <input type="text" value="${i}" disabled style="width: 50px;">
                    <input type="text" class="player-name" placeholder="Player ${i}" value="Player ${i}">
                    <select class="player-role" onchange="updateRoleColor(this)">
                        <option value="Villager">Villager</option>
                        <option value="Mafia">Mafia</option>
                        <option value="Doctor">Doctor</option>
                        <option value="Detective">Detective</option>
                    </select>
                    <button onclick="removePlayerRow(this)" class="danger" style="padding: 5px 10px; margin: 0;">Remove</button>
                `;
                list.appendChild(div);
                // Trigger update for default value (Villager)
                updateRoleColor(div.querySelector('.player-role'));
            }

            document.getElementById('playerSetup').classList.remove('hidden');
        }

        function updateRoleColor(select) {
            select.classList.remove('select-mafia', 'select-doctor', 'select-detective');
            if (select.value === 'Mafia') select.classList.add('select-mafia');
            else if (select.value === 'Doctor') select.classList.add('select-doctor');
            else if (select.value === 'Detective') select.classList.add('select-detective');
        }

        function removePlayerRow(btn) {
            const row = btn.parentElement;
            row.remove();
            renumberPlayers();
        }

        function renumberPlayers() {
            const rows = document.querySelectorAll('.player-row');
            rows.forEach((row, index) => {
                const num = index + 1;
                row.setAttribute('data-player-num', num);
                row.querySelector('input[disabled]').value = num;
            });
            document.getElementById('numPlayers').value = rows.length;
        }

        function addPlayer() {
            const list = document.getElementById('playerList');
            const currentNum = list.children.length + 1;

            const div = document.createElement('div');
            div.style.display = 'grid';
            div.style.gridTemplateColumns = '50px 1fr 1fr 80px';
            div.style.gap = '10px';
            div.style.marginBottom = '10px';
            div.className = 'player-row';
            div.setAttribute('data-player-num', currentNum);
            div.innerHTML = `
                <input type="text" value="${currentNum}" disabled style="width: 50px;">
                <input type="text" class="player-name" placeholder="Player ${currentNum}" value="Player ${currentNum}">
                <select class="player-role">
                    <option value="Villager">Villager</option>
                    <option value="Mafia">Mafia</option>
                    <option value="Doctor">Doctor</option>
                    <option value="Detective">Detective</option>
                </select>
                <button onclick="removePlayerRow(this)" class="danger" style="padding: 5px 10px; margin: 0;">Remove</button>
            `;
            list.appendChild(div);
            document.getElementById('numPlayers').value = currentNum;
        }

        async function randomizeRoles() {
            const numPlayers = document.querySelectorAll('.player-row').length;
            if (numPlayers < 3) {
                await showAlert('Need at least 3 players to randomize.', 'Error');
                return;
            }

            const roles = [];
            // Basic logic: 
            // 1 Detective, 1 Doctor (if > 3 players)
            // Mafia approx 1/3 or 1/4? Let's say: 3-5 players = 1 Mafia. 6-8 = 2 Mafia. 9+ = 3 Mafia.

            let numMafia = 1;
            if (numPlayers >= 6) numMafia = 2;
            if (numPlayers >= 9) numMafia = 3;

            let numDoctor = 1;
            let numDetective = 1;

            if (numPlayers === 3) { numDoctor = 0; numDetective = 0; } // Very small game

            let numVillagers = numPlayers - numMafia - numDoctor - numDetective;

            // Fill array
            for (let i = 0; i < numMafia; i++) roles.push('Mafia');
            for (let i = 0; i < numDoctor; i++) roles.push('Doctor');
            for (let i = 0; i < numDetective; i++) roles.push('Detective');
            for (let i = 0; i < numVillagers; i++) roles.push('Villager');

            // Shuffle
            for (let i = roles.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [roles[i], roles[j]] = [roles[j], roles[i]];
            }

            // Assign
            const playerRows = document.querySelectorAll('.player-row');
            playerRows.forEach((row, index) => {
                const select = row.querySelector('.player-role');
                select.value = roles[index];
                updateRoleColor(select);
            });

            await showAlert(`Roles Randomized!\nMafia: ${numMafia}\nDoctor: ${numDoctor}\nDetective: ${numDetective}\nVillagers: ${numVillagers}`, 'Roles Assigned');
        }

        async function startGame() {
            if (!await showConfirm('Start the game with these players?', 'Start Game')) return;

            const playerRows = document.querySelectorAll('.player-row');
            gameState.players = [];

            playerRows.forEach((row, index) => {
                const nameInput = row.querySelector('.player-name');
                const roleSelect = row.querySelector('.player-role');

                gameState.players.push({
                    number: index + 1,
                    name: nameInput.value,
                    role: roleSelect.value,
                    alive: true,
                    deathReason: '',
                    notes: ''
                });
            });

            if (gameState.players.length === 0) {
                await showAlert('Please add at least one player!', 'Error');
                return;
            }

            gameState.currentRound = 1;
            gameState.roundType = 'night';
            gameState.history = [];
            gameState.votes = [];

            saveGame();
            document.getElementById('setupSection').classList.add('hidden');
            document.getElementById('gameSection').classList.remove('hidden');
            updateGameDisplay();
            showSection('nightTab'); // Start with Night Actions
        }

        function updateGameDisplay() {
            updateRoundDisplay();
            updatePlayersTable();
            updateDropdowns();
            updateHistory();
        }

        function updateRoundDisplay() {
            const type = gameState.roundType.charAt(0).toUpperCase() + gameState.roundType.slice(1);
            document.getElementById('roundDisplay').textContent = `${type} ${gameState.currentRound}`;
        }

        function updatePlayersTable() {
            const tbody = document.getElementById('playersTableBody');
            tbody.innerHTML = '';

            gameState.players.forEach((p, idx) => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${p.number}</td>
                    <td>${p.name}</td>
                    <td class="role-${p.role.toLowerCase()}">${p.role}</td>
                    <td class="${p.alive ? 'status-alive' : 'status-dead'}">${p.alive ? 'Alive' : 'Dead'}</td>
                    <td>${p.deathReason}</td>
                    <td><input type="text" value="${p.notes}" onchange="updateNote(${idx}, this.value)" style="width: 150px;"></td>
                    <td>
                        <button onclick="editPlayer(${idx})" style="padding: 5px 10px; margin: 0;">Edit</button>
                        ${p.alive ? `<button onclick="killPlayer(${idx})" class="danger" style="padding: 5px 10px; margin: 0;">Kill</button>` : ''}
                    </td>
                `;
            });
        }

        function updateDropdowns() {
            const alivePlayers = gameState.players.filter(p => p.alive);

            // Mafia Target: Exclude Mafia members
            const mafiaTargetSelect = document.getElementById('mafiaTarget');
            mafiaTargetSelect.innerHTML = '<option value="">-</option>';
            alivePlayers.filter(p => p.role !== 'Mafia').forEach(p => {
                mafiaTargetSelect.innerHTML += `<option value="${p.number}">${p.name}</option>`;
            });

            // Doctor Save: All alive players (can self-save usually)
            const doctorSaveSelect = document.getElementById('doctorSave');
            doctorSaveSelect.innerHTML = '<option value="">-</option>';
            alivePlayers.forEach(p => {
                doctorSaveSelect.innerHTML += `<option value="${p.number}">${p.name}</option>`;
            });

            // Detective Investigate: Exclude Detectives
            const detectiveSelect = document.getElementById('detectiveInvestigate');
            detectiveSelect.innerHTML = '<option value="">-</option>';
            alivePlayers.filter(p => p.role !== 'Detective').forEach(p => {
                detectiveSelect.innerHTML += `<option value="${p.number}">${p.name}</option>`;
            });

            // Eliminate List (Day): All alive players
            const eliminateSelect = document.getElementById('eliminatedPlayer');
            eliminateSelect.innerHTML = '<option value="">-</option>';
            alivePlayers.forEach(p => {
                eliminateSelect.innerHTML += `<option value="${p.number}">${p.name}</option>`;
            });

            // Hide/Disable Detective Section if no Detective is alive
            const detectiveAlive = alivePlayers.some(p => p.role === 'Detective');
            const detectiveSection = document.getElementById('detectiveSection');
            if (detectiveAlive) {
                detectiveSection.style.display = 'block';
            } else {
                detectiveSection.style.display = 'none';
            }
        }

        function updateNote(idx, value) {
            gameState.players[idx].notes = value;
            saveGame();
        }

        function editPlayer(idx) {
            const p = gameState.players[idx];
            const newName = prompt('Player Name:', p.name);
            if (newName) p.name = newName;

            const newRole = prompt('Role (Mafia/Doctor/Detective/Villager):', p.role);
            if (newRole) p.role = newRole;

            saveGame();
            updateGameDisplay();
        }

        async function killPlayer(idx) {
            const p = gameState.players[idx];
            if (!await showConfirm(`Kill ${p.name}?`, 'Confirm Kill')) return;

            const reason = prompt('Death reason:', 'Killed by Mafia');
            p.alive = false;
            p.deathReason = reason;

            p.deathReason = reason;

            saveGame();
            updateGameDisplay();
            await checkWinCondition();
        }

        async function nextRound() {
            if (!await showConfirm('Move to next round?', 'Phase Change')) return;

            if (gameState.roundType === 'night') {
                gameState.roundType = 'day';
            } else {
                gameState.roundType = 'night';
                gameState.currentRound++;
            }

            gameState.votes = [];
            saveGame();
            updateGameDisplay();

            // Auto-switch tab based on phase
            if (gameState.roundType === 'night') {
                showSection('nightTab');
            } else {
                showSection('dayTab');
            }
        }

        async function processNight() {
            if (!await showConfirm('Process night actions?', 'Process Night')) return;

            const mafiaTarget = parseInt(document.getElementById('mafiaTarget').value);
            const doctorSave = parseInt(document.getElementById('doctorSave').value);
            const detectiveInv = parseInt(document.getElementById('detectiveInvestigate').value);

            // Automate Investigation Result
            let invResult = '-';
            if (detectiveInv) {
                const targetPlayer = gameState.players.find(p => p.number === detectiveInv);
                if (targetPlayer) {
                    invResult = (targetPlayer.role === 'Mafia') ? 'Mafia' : 'Not Mafia';
                }
            }

            let outcome = '';
            let dead = null;

            if (mafiaTarget && mafiaTarget === doctorSave) {
                outcome = `Mafia targeted ${getPlayerName(mafiaTarget)}, but Doctor saved them!`;
            } else if (mafiaTarget) {
                const player = gameState.players.find(p => p.number === mafiaTarget);
                player.alive = false;
                player.deathReason = 'Killed by Mafia';
                dead = mafiaTarget;
                outcome = `${getPlayerName(mafiaTarget)} was killed by Mafia.`;
            } else {
                outcome = 'No one died tonight.';
            }

            if (detectiveInv) {
                outcome += `\n\nüïµÔ∏è‚Äç‚ôÇÔ∏è Detective Investigation:\n${getPlayerName(detectiveInv)} is ${invResult}.`;
            } else if (gameState.players.some(p => p.role === 'Detective' && p.alive)) {
                // Warning if detective was alive but didn't act? Optional, but skipping is valid strategy.
            }

            gameState.history.push({
                round: gameState.currentRound,
                type: 'night',
                mafiaTarget: mafiaTarget,
                doctorSave: doctorSave,
                detectiveInvestigate: detectiveInv,
                investigationResult: invResult,
                outcome: outcome,
                dead: dead
            });

            saveGame();
            updateGameDisplay();
            await showAlert(outcome, 'Night Outcome');
            await checkWinCondition();
            nextRound(); // Auto-trigger next round with confirmation
        }

        function addVote() {
            gameState.votes.push({ voter: '', target: '' });
            renderVotes();
        }

        function addVoteForAllPlayers() {
            const alivePlayers = gameState.players.filter(p => p.alive);
            const usedVoters = gameState.votes.map(v => v.voter);
            const availableVoters = alivePlayers.filter(p => !usedVoters.includes(p.number));

            availableVoters.forEach(player => {
                gameState.votes.push({ voter: player.number, target: '' });
            });

            saveGame();
            renderVotes();
        }

        function renderVotes() {
            const list = document.getElementById('votesList');
            list.innerHTML = '';

            const alivePlayers = gameState.players.filter(p => p.alive);
            const usedVoters = gameState.votes.map(v => v.voter);

            gameState.votes.forEach((v, idx) => {
                const availableVoters = alivePlayers.filter(p =>
                    p.number === v.voter || !usedVoters.includes(p.number)
                );

                const div = document.createElement('div');
                div.className = 'vote-row';
                div.innerHTML = `
                    <select onchange="updateVote(${idx}, 'voter', this.value)">
                        <option value="">Voter</option>
                        ${availableVoters.map(p =>
                    `<option value="${p.number}" ${v.voter === p.number ? 'selected' : ''}>${p.name}</option>`
                ).join('')}
                    </select>
                    <span style="color: #4ecdc4;">‚Üí</span>
                    <select onchange="updateVote(${idx}, 'target', this.value)">
                        <option value="">Target</option>
                        ${alivePlayers.map(p =>
                    `<option value="${p.number}" ${v.target === p.number ? 'selected' : ''}>${p.name}</option>`
                ).join('')}
                    </select>
                    <button onclick="removeVote(${idx})" class="danger">Remove</button>
                `;
                list.appendChild(div);
            });
        }

        function updateVote(idx, field, value) {
            gameState.votes[idx][field] = parseInt(value);
            saveGame();
        }

        function removeVote(idx) {
            gameState.votes.splice(idx, 1);
            saveGame();
            renderVotes();
        }

        function tallyVotes() {
            const tally = {};
            const voteDetails = {};

            gameState.votes.forEach(v => {
                if (v.target && v.voter) {
                    tally[v.target] = (tally[v.target] || 0) + 1;
                    if (!voteDetails[v.target]) {
                        voteDetails[v.target] = [];
                    }
                    voteDetails[v.target].push(getPlayerName(v.voter));
                }
            });

            const results = Object.entries(tally)
                .map(([num, count]) => ({ num: parseInt(num), count }))
                .sort((a, b) => b.count - a.count);

            const div = document.getElementById('voteTally');

            if (results.length === 0) {
                div.innerHTML = '<p style="color: #ff6b6b; padding: 20px; text-align: center;">No votes recorded yet!</p>';
                document.getElementById('voteResults').classList.remove('hidden');
                return;
            }

            const maxVotes = results[0].count;
            const topVoted = results.filter(r => r.count === maxVotes);

            div.innerHTML = `
                <div style="background: #1a1a1a; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="color: #4ecdc4; margin-bottom: 15px;">üìä Vote Tally</h3>
                    <table style="width: 100%;">
                        <thead>
                            <tr>
                                <th style="text-align: left; padding: 10px; background: #2a2a2a;">Player</th>
                                <th style="text-align: center; padding: 10px; background: #2a2a2a;">Votes</th>
                                <th style="text-align: left; padding: 10px; background: #2a2a2a;">Voted By</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${results.map(r => `
                                <tr style="background: ${r.count === maxVotes ? '#2a4a2a' : 'transparent'};">
                                    <td style="padding: 10px; font-weight: bold; color: ${r.count === maxVotes ? '#51cf66' : '#e0e0e0'};">
                                        ${getPlayerName(r.num)}
                                    </td>
                                    <td style="padding: 10px; text-align: center; font-size: 24px; font-weight: bold; color: ${r.count === maxVotes ? '#51cf66' : '#ffd93d'};">
                                        ${r.count}
                                    </td>
                                    <td style="padding: 10px; font-size: 13px; color: #b0b0b0;">
                                        ${voteDetails[r.num].join(', ')}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            // Handle elimination logic
            const eliminateSelect = document.getElementById('eliminatedPlayer');
            eliminateSelect.innerHTML = '<option value="">-</option>';

            if (topVoted.length === 1) {
                // Clear winner
                const winner = topVoted[0];
                const player = gameState.players.find(p => p.number === winner.num);
                div.innerHTML += `
                    <div style="background: #4a2a2a; padding: 15px; border-radius: 8px; border-left: 4px solid #ff6b6b;">
                        <strong style="color: #ff6b6b; font-size: 18px;">üéØ ${player.name} has the most votes (${maxVotes}) and will be eliminated!</strong>
                    </div>
                `;
                eliminateSelect.innerHTML += `<option value="${winner.num}" selected>${getPlayerName(winner.num)} (${maxVotes} votes)</option>`;
            } else {
                // Tie situation
                div.innerHTML += `
                    <div style="background: #4a4a2a; padding: 15px; border-radius: 8px; border-left: 4px solid #ffd93d;">
                        <strong style="color: #ffd93d; font-size: 18px;">‚ö†Ô∏è TIE! ${topVoted.length} players have ${maxVotes} votes each.</strong><br>
                        <span style="color: #b0b0b0;">No one will be eliminated automatically. Select a player below to eliminate manually, or skip elimination.</span>
                    </div>
                `;
                topVoted.forEach(r => {
                    eliminateSelect.innerHTML += `<option value="${r.num}">${getPlayerName(r.num)} (${r.count} votes - TIED)</option>`;
                });
            }

            document.getElementById('voteResults').classList.remove('hidden');
        }

        async function processDay() {
            const eliminated = parseInt(document.getElementById('eliminatedPlayer').value);
            if (!eliminated) {
                if (await showConfirm('No player selected. Skip elimination for this day?', 'Skip Elimination')) {
                    gameState.history.push({
                        round: gameState.currentRound,
                        type: 'day',
                        votes: [...gameState.votes],
                        eliminated: null,
                        eliminatedRole: null,
                        skipped: true
                    });

                    gameState.votes = [];
                    saveGame();
                    updateGameDisplay();
                    document.getElementById('voteResults').classList.add('hidden');
                    await showAlert('No one was eliminated today.', 'Day Skipped');
                    nextRound(); // Auto-trigger next round
                }
                return;
            }

            if (!await showConfirm(`Eliminate ${getPlayerName(eliminated)}?`, 'Confirm Elimination')) return;

            const player = gameState.players.find(p => p.number === eliminated);
            player.alive = false;
            player.deathReason = 'Eliminated by Vote';

            gameState.history.push({
                round: gameState.currentRound,
                type: 'day',
                votes: [...gameState.votes],
                eliminated: eliminated,
                eliminatedRole: player.role
            });

            gameState.votes = [];
            saveGame();
            updateGameDisplay();

            document.getElementById('voteResults').classList.add('hidden');
            await showAlert(`${player.name} (${player.role}) was eliminated.`, 'Elimination Result');
            await checkWinCondition();
            nextRound(); // Auto-trigger next round
        }

        function updateHistory() {
            const list = document.getElementById('historyList');
            list.innerHTML = '';

            gameState.history.slice().reverse().forEach(h => {
                const div = document.createElement('div');
                div.className = `history-item history-${h.type}`;

                if (h.type === 'night') {
                    div.innerHTML = `
                        <strong>Night ${h.round}</strong><br>
                        Mafia Target: ${getPlayerName(h.mafiaTarget)}<br>
                        Doctor Save: ${getPlayerName(h.doctorSave)}<br>
                        Detective: ${getPlayerName(h.detectiveInvestigate)} ‚Üí ${h.investigationResult || '-'}<br>
                        <strong>Outcome:</strong> ${h.outcome}
                    `;
                } else {
                    div.innerHTML = `
                        <strong>Day ${h.round}</strong><br>
                        Votes Cast: ${h.votes.length}<br>
                        ${h.skipped ? '<span style="color: #ffd93d;">No elimination (Tie or Skip)</span>' :
                            `Eliminated: ${getPlayerName(h.eliminated)} (${h.eliminatedRole})`}
                    `;
                }

                list.appendChild(div);
            });
        }

        function getPlayerName(num) {
            if (!num) return '-';
            const p = gameState.players.find(p => p.number === num);
            return p ? p.name : '-';
        }

        function showSection(tab) {
            ['playersTab', 'nightTab', 'dayTab', 'historyTab'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(tab).classList.remove('hidden');

            if (tab === 'dayTab') {
                renderVotes();
            }
        }

        async function resetGame() {
            if (!await showConfirm('Reset entire game? This cannot be undone!', 'Reset Game')) return;
            // Second confirmation just to be safe, can use logic inside if needed or just one sturdy one. 
            // We'll stick to one distinct modal for now or chain them.
            // Let's chain it for extra safety.
            if (!await showConfirm('Are you absolutely sure?', 'Double Check')) return;

            localStorage.removeItem('mafiaGame');
            location.reload();
        }

        async function checkWinCondition() {
            const aliveMafia = gameState.players.filter(p => p.alive && p.role === 'Mafia').length;
            const aliveVillagers = gameState.players.filter(p => p.alive && p.role !== 'Mafia').length;

            if (aliveMafia === 0) {
                await showAlert('üèÜ VILLAGERS WIN!\nAll Mafia members are eliminated.', 'Game Over');
                // Optional: resetGame();
            } else if (aliveMafia >= aliveVillagers) {
                await showAlert('üïµÔ∏è‚Äç‚ôÇÔ∏è MAFIA WINS!\nMafia outnumber or equal the villagers.', 'Game Over');
            }
        }

        loadGame();
    </script>
</body>

</html>